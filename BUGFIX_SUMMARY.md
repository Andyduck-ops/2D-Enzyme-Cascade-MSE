# Bug Fix Summary

## ä¿®å¤çš„é—®é¢˜ (2025-10-13)

### 1. âœ… ååº”â€œå†·å´æœŸâ€è¢«æ”¾å¤§ä¸éå†åç½®å¯¼è‡´ç²¾åº¦å¤±çœŸ
**é—®é¢˜æè¿°ï¼š**
- å¿™ç¢Œ/å‘¨è½¬æ—¶é—´ä»¥â€œæ•´æ­¥â€è®¡æ•°ï¼Œ`dt`ç¨å¤§æ—¶ä¼šè¢«å¤¸å¤§ï¼ˆä¾‹å¦‚çœŸå®0.01sè¢«é‡åŒ–ä¸º0.1sï¼‰ï¼Œæ€»ä½“é€Ÿç‡åä½ï¼›
- å›ºå®šé…¶éå†é¡ºåºå¼•å…¥â€œå…ˆæ‰‹æŠ¢å â€åç½®ï¼›
- çº¿æ€§è¿‘ä¼¼æ¦‚ç‡`kÂ·dt`åœ¨å¤§`dt`ä¸‹å¯æº¢å‡ºåˆ°>1ã€‚

**ä¿®å¤æ–¹æ¡ˆï¼š**
- æ”¹ä¸ºâ€œè¿ç»­æ—¶é—´è®¡æ—¶å™¨â€ï¼Œå®šæ—¶å™¨æŒ‰ç§’é€’å‡ï¼ˆæ¯æ­¥å‡`dt`ï¼‰ï¼Œé¿å…æ•´æ­¥æ”¾å¤§ï¼›
- æ¯æ­¥éšæœºåŒ–é…¶éå†é¡ºåºï¼ˆ`randperm`ï¼‰ä»¥æ¶ˆé™¤é¡ºåºåç½®ï¼›
- çº¿æ€§è¿‘ä¼¼æ¨¡å¼å¢åŠ [0,1]å®‰å…¨é’³åˆ¶ï¼›
- æ–°å¢`config_sanity_checks()`å¯¹`k_maxÂ·dt`ä¸æ‰©æ•£æ­¥é•¿Ïƒç»™å‡ºè­¦å‘Šï¼›
- æ–°å¢`auto_adjust_dt()`è‡ªåŠ¨å°†`dt`å›é€€å‡åŠç›´è‡³æ»¡è¶³ç²¾åº¦é—¨æ§›ï¼ˆå¹¶è®°å½•æ—¥å¿—ï¼‰ã€‚

**å½±å“æ–‡ä»¶ï¼š**
- `modules/utils/timer_busy_update.m`ï¼ˆè¿ç»­æ—¶é—´è®¡æ—¶å™¨ï¼‰
- `modules/sim_core/reaction_step.m`ï¼ˆéšæœºéå†ã€æ¦‚ç‡é’³åˆ¶ï¼‰
- `modules/utils/config_sanity_checks.m`ï¼ˆç²¾åº¦ä½“æ£€ï¼‰
- `modules/utils/auto_adjust_dt.m`ã€`main_2d_pipeline.m`ï¼ˆè‡ªåŠ¨dtä¸æ—¥å¿—ï¼‰

---

### 2. âœ… å•æ¬¡è®¡ç®—çƒ­ç‚¹æœªä¼˜åŒ–ã€GPUå¼€å…³ä»…å½±å“RNGï¼ˆæ˜“è¯¯å¯¼ï¼‰
**é—®é¢˜æè¿°ï¼š**
- æ¯æ­¥ä¸¤æ¬¡`pdist2`å…¨è·é˜µæœç´¢æ˜¯ä¸»è€—æ—¶ï¼›
- äº¤äº’é‡Œçš„GPUå¼€å…³ä»…å½±å“RNGï¼ˆ`gpurng`ï¼‰ï¼Œä¸å½±å“è®¡ç®—ï¼Œé€ æˆâ€œå¼€äº†GPUä¹Ÿä¸å¿«â€çš„ä½“éªŒã€‚

**ä¿®å¤æ–¹æ¡ˆï¼š**
- æŠ½è±¡é‚»åŸŸæœç´¢åç«¯ï¼š`pdist2` / `rangesearch`ï¼ˆKD-treeï¼‰/ GPU çŸ©é˜µä¹˜æ³•ï¼›
- æ–°å¢è®¡ç®—å¼€å…³ï¼š`config.compute.neighbor_backend`ã€`config.compute.use_gpu`ï¼›
- äº¤äº’ä¸­å°†`batch.use_gpu`è”åŠ¨æ˜ å°„è‡³`compute.use_gpu`ï¼ˆä¿æŒç”¨æˆ·ç®€å•å¿ƒæ™ºï¼‰ã€‚

**å½±å“æ–‡ä»¶ï¼š**
- `modules/sim_core/neighbor_search.m`ï¼ˆæ–°ï¼‰
- `modules/sim_core/reaction_step.m`ï¼ˆæ¥å…¥å¯æ’æ‹”åç«¯ï¼‰
- `modules/config/default_config.m`ï¼ˆæ–°å¢computeé…ç½®ï¼‰
- `modules/config/interactive_config.m`ï¼ˆGPUäº¤äº’è”åŠ¨ä¸æ‘˜è¦æ‰“å°ï¼‰

---

### 3. âœ… å¯è§†åŒ–ä¸ä¼˜é›…ï¼ˆä¸»é¢˜é€‚é…ã€ç®±çº¿å›¾è´´è¾¹ä¸æ ‡æ³¨é‡å ï¼‰
**é—®é¢˜æè¿°ï¼š**
- å‚è€ƒçº¿ä¸æ³¨é‡Šæ¡†å›ºå®šé»‘ç™½è‰²ï¼Œæš—è‰²ä¸»é¢˜ä¸‹çªå…€ï¼›
- ç®±çº¿å›¾ä¸Šä¸‹è´´è¾¹ï¼Œç¦»ç¾¤ç‚¹/ç®±é¡»â€œæŒ¤åœ¨è¾¹ç•Œâ€ï¼›
- ç±»ç›®å¤šæ—¶åˆ»åº¦/æ ‡æ³¨é‡å ï¼›äº‹ä»¶ç‚¹è¿‡å¯†ä¸é€šé€ã€‚

**ä¿®å¤æ–¹æ¡ˆï¼š**
- ä¸»é¢˜è‡ªé€‚åº”ï¼šå‚è€ƒçº¿/æ³¨é‡Šæ¡†ä½¿ç”¨å‰æ™¯/èƒŒæ™¯è‰²ï¼›
- å…¨å±€`axis padded`å‡å°‘å‰ªåˆ‡ï¼›äº‹ä»¶ç‚¹åŠé€æ˜ï¼›
- ç®±çº¿å›¾è‡ªåŠ¨ä¸Šä¸‹é¢„ç•™ï¼šè¾¹è·=min(200, max(1, 0.05Â·è·¨åº¦))ï¼›
- æ ¹æ®åˆ†ç»„æ•°åŠ¨æ€`xlim`å¹¶æ—‹è½¬åˆ»åº¦ï¼ˆ20Â°ï¼‰å‡å°‘é‡å ï¼›
- ç»Ÿä¸€å›¾ä¾‹å­—å·ä½¿ç”¨é…ç½®ã€‚

**å½±å“æ–‡ä»¶ï¼š**
- `modules/viz/viz_style.m`ï¼ˆtightâ†’paddedï¼‰
- `modules/viz/plot_enhancement_factor.m`ï¼ˆä¸»é¢˜è‡ªé€‚åº”å‚è€ƒçº¿ä¸æ³¨é‡Šï¼‰
- `modules/viz/plot_event_map.m`ï¼ˆMarkerFaceAlphaã€å›¾ä¾‹å­—å·ï¼‰
- `modules/viz/plot_reaction_rate_analysis.m`ï¼ˆå›¾ä¾‹å­—å·ç»Ÿä¸€ï¼‰
- `modules/viz/plot_batch_distribution.m`ï¼ˆç®±çº¿å›¾yè½´é¢„ç•™ã€åˆ»åº¦æ—‹è½¬ã€åŠ¨æ€xlimï¼‰
- `modules/config/default_config.m`ï¼ˆç®±çº¿å›¾è¾¹è·é…ç½®é¡¹ï¼‰

---

### 4. âœ… å¯å¤ç°è®°å½•å¢å¼ºï¼ˆdtè‡ªé€‚åº”æ—¥å¿—ä¸å…ƒæ•°æ®ï¼‰
**é—®é¢˜æè¿°ï¼š**
- è‡ªåŠ¨è°ƒæ•´`dt`åéœ€è¦å®Œæ•´è®°å½•è¿‡ç¨‹ä»¥ä¿è¯å¤ç°ã€‚

**ä¿®å¤æ–¹æ¡ˆï¼š**
- åœ¨`out/.../data/`å†™å…¥`dt_history.txt`è®°å½•åˆå§‹/æœ€ç»ˆdtä¸å†å²åºåˆ—ï¼›
- åœ¨`run_metadata.json`æ–°å¢ï¼š`auto_dt_enabled`ã€`dt_initial`ã€`dt_final`ã€`dt_history`ã€`kdt_final`ã€`sigma_final`ä¸ç›®æ ‡é˜ˆå€¼ç­‰ã€‚

**å½±å“æ–‡ä»¶ï¼š**
- `main_2d_pipeline.m`ï¼ˆå†™å…¥æ—¥å¿—ï¼‰
- `modules/io/write_metadata.m`ï¼ˆæ–°å¢å…ƒæ•°æ®å­—æ®µï¼‰

---

### 5. ğŸ§¹ æ¸…ç†å†—ä½™
**å†…å®¹ï¼š** ç§»é™¤ä¸å†éœ€è¦çš„ `å¤ç°seed.txt`ã€‚

---

## æµ‹è¯•å»ºè®®ï¼ˆæœ¬æ¬¡å˜æ›´ï¼‰
- dt æ”¶æ•›ï¼šé€æ­¥å‡åŠ`dt`ï¼Œäº§ç‰©æ›²çº¿å˜åŒ–<5% åˆ¤ä¸ºå¯æ¥å—ï¼›
- é‚»åŸŸåç«¯ä¸€è‡´æ€§ï¼šåŒä¸€seedä¸‹`pdist2`/`rangesearch`/GPUç»Ÿè®¡ä¸€è‡´ï¼ˆæ³¢åŠ¨èŒƒå›´å†…ï¼‰ï¼›
- ç®±çº¿å›¾ï¼šæ ·æœ¬å¸¦ç¦»ç¾¤ç‚¹/æå€¼æ—¶ä¸å†è´´è¾¹ï¼›å¤šç»„ç±»ç›®åˆ»åº¦ä¸é‡å ã€‚

## ç‰ˆæœ¬ä¿¡æ¯
- ä¿®å¤æ—¥æœŸï¼š2025-10-13
- ä¿®å¤ç‰ˆæœ¬ï¼šv1.2.0
- ä¿®å¤äººå‘˜ï¼šKiro AI Assistant

## ä¿®å¤çš„é—®é¢˜ (2025-10-10)

### 1. âŒ æ‰¹æ¬¡è¿è¡Œä¸åº”è¯¥æœ‰ single_viz æ–‡ä»¶å¤¹
**é—®é¢˜æè¿°ï¼š** æ‰¹æ¬¡è¿è¡Œæ—¶ä¼šåˆ›å»º `single_viz/` æ–‡ä»¶å¤¹ï¼Œä½†è¿™ä¸ªæ–‡ä»¶å¤¹åº”è¯¥åªç”¨äºå•æ¬¡è¿è¡Œçš„å¯è§†åŒ–ã€‚

**ä¿®å¤æ–¹æ¡ˆï¼š**
- ç§»é™¤ `output_manager.m` ä¸­åˆ›å»º `single_viz` ç›®å½•çš„é€»è¾‘
- ä¿®æ”¹ `main_2d_pipeline.m`ï¼Œåªåœ¨ `batch_count == 1` æ—¶è¿è¡Œå•æ¬¡å¯è§†åŒ–
- æ‰¹æ¬¡è¿è¡Œåªç”Ÿæˆç»Ÿè®¡å›¾è¡¨ï¼Œä¸ç”Ÿæˆå•æ¬¡è¿è¡Œçš„å¿«ç…§

**å½±å“æ–‡ä»¶ï¼š**
- `modules/io/output_manager.m`
- `main_2d_pipeline.m`

---

### 2. âŒ å›¾ç‰‡æ²¡æœ‰æ­£ç¡®ä¿å­˜åˆ°è¾“å‡ºæ–‡ä»¶å¤¹
**é—®é¢˜æè¿°ï¼š** æ‰€æœ‰å›¾ç‰‡åº”è¯¥ä¿å­˜åˆ° `figures/` ç›®å½•ï¼Œä½†æœ‰äº›ä¿å­˜åˆ°äº†é”™è¯¯çš„ä½ç½®ã€‚

**ä¿®å¤æ–¹æ¡ˆï¼š**
- ç»Ÿä¸€æ‰€æœ‰ `save_figures()` è°ƒç”¨ä½¿ç”¨ `config.io.figures_dir`
- ç§»é™¤ä½¿ç”¨ `viz_outdir` å˜é‡çš„é€»è¾‘
- ç¡®ä¿åŠ¨ç”»è§†é¢‘ä¹Ÿä¿å­˜åˆ° `figures/` ç›®å½•

**å½±å“æ–‡ä»¶ï¼š**
- `main_2d_pipeline.m`

---

### 3. âŒ æ‰¹æ¬¡è¿è¡Œä¸åº”è¯¥åŒ…å«å•æ¬¡è¿è¡Œçš„å¿«ç…§
**é—®é¢˜æè¿°ï¼š** æ‰¹æ¬¡è¿è¡Œæ—¶ä¼šç”Ÿæˆå•æ¬¡è¿è¡Œçš„å¿«ç…§å›¾ï¼ˆå¦‚ snapshotã€tracer ç­‰ï¼‰ï¼Œè¿™äº›åº”è¯¥åªåœ¨å•æ¬¡è¿è¡Œæ—¶ç”Ÿæˆã€‚

**ä¿®å¤æ–¹æ¡ˆï¼š**
- æ·»åŠ æ¡ä»¶åˆ¤æ–­ï¼šåªåœ¨ `batch_count == 1` æ—¶è¿è¡Œå•æ¬¡å¯è§†åŒ–
- æ‰¹æ¬¡è¿è¡Œï¼ˆ`batch_count > 1`ï¼‰åªç”Ÿæˆç»Ÿè®¡å›¾è¡¨ï¼š
  - Dual system comparison
  - Batch distribution
  - Enhancement factor
  - MC convergence
  - Batch timeseries heatmap

**å½±å“æ–‡ä»¶ï¼š**
- `main_2d_pipeline.m`

---

### 4. âš ï¸ MP4 è§†é¢‘æ— æ³•æ’­æ”¾
**å¯èƒ½åŸå› ï¼š**
- ç¼–ç å™¨é—®é¢˜
- å¸§ç‡è®¾ç½®é—®é¢˜
- è§†é¢‘è´¨é‡è®¾ç½®é—®é¢˜

**å»ºè®®æ£€æŸ¥ï¼š**
1. ç¡®è®¤ MATLAB ç‰ˆæœ¬æ”¯æŒ MPEG-4 ç¼–ç 
2. å°è¯•ä½¿ç”¨å…¶ä»–è§†é¢‘æ’­æ”¾å™¨ï¼ˆVLCã€Windows Media Playerï¼‰
3. æ£€æŸ¥ `animate_snapshots.m` ä¸­çš„ç¼–ç è®¾ç½®

**å½“å‰è®¾ç½®ï¼š**
```matlab
v = VideoWriter(video_path, 'MPEG-4');
v.FrameRate = 10;  % é»˜è®¤ 10 fps
v.Quality = 95;    % é«˜è´¨é‡
```

---

## ä¿®å¤åçš„ç›®å½•ç»“æ„

### å•æ¬¡è¿è¡Œ (batch_count = 1)
```
out/single/20251010_143022_mse_enz400_sub3000_seed1234/
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ run_metadata.json
â”‚   â”œâ”€â”€ seeds.csv
â”‚   â””â”€â”€ batch_results.csv
â””â”€â”€ figures/
    â”œâ”€â”€ viz_seed_1234_01_ProductCurve.png
    â”œâ”€â”€ viz_seed_1234_02_ReactionRate.png
    â”œâ”€â”€ viz_seed_1234_03_Snapshot_t0.png
    â”œâ”€â”€ viz_seed_1234_04_EventMap.png
    â”œâ”€â”€ viz_seed_1234_05_Tracers.png
    â””â”€â”€ animation_seed_1234.mp4  (å¦‚æœå¯ç”¨)
```

### æ‰¹æ¬¡è¿è¡Œ (batch_count > 1)
```
out/batch/20251010_143530_mse_enz400_sub3000_n10/
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ run_metadata.json
â”‚   â”œâ”€â”€ seeds.csv
â”‚   â””â”€â”€ batch_results.csv
â””â”€â”€ figures/
    â””â”€â”€ (åªæœ‰ç»Ÿè®¡å›¾è¡¨ï¼Œæ²¡æœ‰å•æ¬¡è¿è¡Œçš„å¿«ç…§)
```

### Dual æ¨¡å¼æ‰¹æ¬¡è¿è¡Œ
```
out/batch/20251010_143530_dual_enz400_sub3000_n10/
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ run_metadata.json
â”‚   â”œâ”€â”€ seeds.csv
â”‚   â”œâ”€â”€ batch_results_bulk.csv
â”‚   â”œâ”€â”€ batch_results_mse.csv
â”‚   â”œâ”€â”€ timeseries_products_bulk.csv
â”‚   â””â”€â”€ timeseries_products_mse.csv
â””â”€â”€ figures/
    â”œâ”€â”€ dual_comparison_enzymes_400.png
    â”œâ”€â”€ stats_enzymes_400_01_BatchDistribution.png
    â”œâ”€â”€ stats_enzymes_400_02_EnhancementFactor.png
    â”œâ”€â”€ stats_enzymes_400_03_MCConvergence_Bulk.png
    â”œâ”€â”€ stats_enzymes_400_04_MCConvergence_MSE.png
    â”œâ”€â”€ stats_enzymes_400_05_Heatmap_Bulk.png
    â””â”€â”€ stats_enzymes_400_06_Heatmap_MSE.png
```

---

## æµ‹è¯•å»ºè®®

### æµ‹è¯• 1ï¼šå•æ¬¡è¿è¡Œ
```matlab
main_2d_pipeline
% é€‰æ‹©ï¼š
% - Batch count = 1
% - Visualization = y
% - Animation = y (å¯é€‰)
% - Figure save = y

% é¢„æœŸç»“æœï¼š
% - åœ¨ out/single/ ä¸‹åˆ›å»ºæ—¶é—´æˆ³ç›®å½•
% - figures/ åŒ…å«æ‰€æœ‰å¯è§†åŒ–å›¾ç‰‡
% - å¦‚æœå¯ç”¨åŠ¨ç”»ï¼ŒåŒ…å« .mp4 æ–‡ä»¶
% - æ²¡æœ‰ single_viz/ æ–‡ä»¶å¤¹
```

### æµ‹è¯• 2ï¼šæ‰¹æ¬¡è¿è¡Œï¼ˆé Dualï¼‰
```matlab
main_2d_pipeline
% é€‰æ‹©ï¼š
% - Batch count = 10
% - Visualization = n  (æ‰¹æ¬¡è¿è¡Œä¸éœ€è¦å•æ¬¡å¯è§†åŒ–)
% - Figure save = y

% é¢„æœŸç»“æœï¼š
% - åœ¨ out/batch/ ä¸‹åˆ›å»ºæ—¶é—´æˆ³ç›®å½•
% - figures/ ä¸ºç©ºï¼ˆå› ä¸ºæ²¡æœ‰å¯ç”¨å¯è§†åŒ–ï¼‰
% - æ²¡æœ‰ single_viz/ æ–‡ä»¶å¤¹
% - æ²¡æœ‰å•æ¬¡è¿è¡Œçš„å¿«ç…§å›¾
```

### æµ‹è¯• 3ï¼šDual æ¨¡å¼æ‰¹æ¬¡è¿è¡Œ
```matlab
main_2d_pipeline
% é€‰æ‹©ï¼š
% - Batch count = 10
% - Dual comparison = y
% - Visualization = n
% - Figure save = y

% é¢„æœŸç»“æœï¼š
% - åœ¨ out/batch/ ä¸‹åˆ›å»ºæ—¶é—´æˆ³ç›®å½•
% - figures/ åŒ…å«ç»Ÿè®¡å›¾è¡¨ï¼ˆdual comparison, distributions, etc.ï¼‰
% - æ²¡æœ‰ single_viz/ æ–‡ä»¶å¤¹
% - æ²¡æœ‰å•æ¬¡è¿è¡Œçš„å¿«ç…§å›¾
```

---

## æ³¨æ„äº‹é¡¹

1. **æ‰¹æ¬¡è¿è¡Œçš„å¯è§†åŒ–**ï¼šæ‰¹æ¬¡è¿è¡Œåº”è¯¥å…³æ³¨ç»Ÿè®¡ç»“æœï¼Œä¸éœ€è¦å•æ¬¡è¿è¡Œçš„è¯¦ç»†å¯è§†åŒ–
2. **å•æ¬¡è¿è¡Œçš„å¯è§†åŒ–**ï¼šåªæœ‰ `batch_count = 1` æ—¶æ‰ç”Ÿæˆè¯¦ç»†çš„å¿«ç…§ã€è½¨è¿¹ç­‰å›¾
3. **å›¾ç‰‡ä¿å­˜ä½ç½®**ï¼šæ‰€æœ‰å›¾ç‰‡ç»Ÿä¸€ä¿å­˜åˆ° `figures/` ç›®å½•
4. **MP4 æ’­æ”¾é—®é¢˜**ï¼šå¦‚æœæ— æ³•æ’­æ”¾ï¼Œå°è¯•ä½¿ç”¨ VLC æ’­æ”¾å™¨æˆ–æ£€æŸ¥ MATLAB ç‰ˆæœ¬

---

## ç‰ˆæœ¬ä¿¡æ¯

- ä¿®å¤æ—¥æœŸï¼š2025-10-10
- ä¿®å¤ç‰ˆæœ¬ï¼šv1.1.0
- ä¿®å¤äººå‘˜ï¼šKiro AI Assistant
